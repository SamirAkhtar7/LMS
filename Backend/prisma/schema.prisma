// =====================
// Prisma Schema: Loan Management System
// =====================
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "mysql"
  // Connection URL moved to prisma.config.ts per Prisma 7+ requirements
}

// ðŸ”´ Soft Delete
// deletedAt DateTime?
// deletedBy String?
// @@index([deletedAt])
// =================================USERS=====================================

model User {
  id            String   @id @default(cuid())
  fullName      String
  userName      String   @unique
  email         String   @unique
  password      String
  role          Role
  contactNumber String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  kycStatus KycStatus @default(PENDING)

  // Relations
  profile  UserProfile?
  admin    Admin?
  partner  Partner?
  employee Employee?

  kycs             Kyc[]
  permissions      UserPermission[]
  leadsAssignedTo  Leads[]           @relation("LeadAssignedTo")
  leadsAssignedBy  Leads[]           @relation("LeadAssignedBy")
  verifiedKycs     Kyc[]             @relation("KycVerifiedBy")
  loanApplications LoanApplication[]
}

model UserProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  dob            DateTime
  gender         String
  meritalStatus  String
  educationLevel String
  occupation     String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])
}

model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])
}

model Employee {
  id         String @id @default(cuid())
  userId     String @unique
  employeeId String @unique

  mobileNumber    String
  atlMobileNumber String
  dob             DateTime
  designation     String
  gender          Gender
  maritalStatus   MaritalStatus

  // Contact & address
  address String
  city    String
  state   String
  pinCode String

  // Emergency
  emergencyContact      String
  emergencyRelationship Relationship

  // Professional
  department         String
  dateOfJoining      DateTime
  experience         String
  reportingManagerId String
  // reportingManager   Employee? @relation("ManagerEmployees", fields: [reportingManagerId], references: [id])
  // subordinates       Employee[] @relation("ManagerEmployees")
  workLocation       WorkLocation
  salary             Float

  // Optional username if separate from `User`

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], map: "fk_employee_user")
}

model Partner {
  id     String @id @default(cuid())
  userId String @unique

  partnerId                  String         @unique
  companyName                String
  contactPerson              String
  alternateNumber            String?
  website                    String?
  establishedYear            Int?
  partnerType                PartnerType
  businessNature             String?
  fullAddress                String?
  city                       String?
  state                      String?
  pinCode                    String?
  designation                String?
  businessCategory           String?
  specialization             String?
  totalEmployees             Int?
  annualTurnover             Float?
  businessRegistrationNumber String?
  commissionType             CommissionType
  commissionValue            Float?
  paymentCycle               PaymentCycle
  minimumPayout              Float?
  taxDeduction               Float?
  targetArea                 String?
  totalReferrals             Int?           @default(0)
  activeReferrals            Int?           @default(0)
  commissionEarned           Float?         @default(0)
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])
}

model Leads {
  id                         String            @id @default(cuid())
  fullName                   String
  contactNumber              String
  leadNumber                 String            @unique
  email                      String
  dob                        DateTime
  gender                     Gender
  loanAmount                 Float
  loanTypeId                 String
  city                       String
  state                      String
  pinCode                    String
  address                    String
  assignedTo                 String?
  assignedBy                 String?
  convertedLoanApplicationId String?
  status                     LeadStatus        @default(PENDING)
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @updatedAt
  // Relations  assignedToUser User? @relation("LeadAssignedTo", fields: [assignedTo], references
  assignedToUser             User?             @relation("LeadAssignedTo", fields: [assignedTo], references: [id])
  assignedByUser             User?             @relation("LeadAssignedBy", fields: [assignedBy], references: [id])
  loanApplications           LoanApplication[]
  loanType                   LoanType          @relation(fields: [loanTypeId], references: [id])

  @@index([leadNumber])
}

model LoanApplication {
  id              String   @id @default(cuid())
  // leadId          String              @unique
  applicationDate DateTime @default(now())
  loanNumber      String   @unique
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  // loanProductId   String
  leadId          String?
  lead            Leads?   @relation(fields: [leadId], references: [id])
  loanTypeId      String
  requestedAmount Float
  approvedAmount  Float?
  tenureMonths    Int?
  interestRate    Float?

  interestType   InterestType
  emiAmount      Float?
  purposeDetails String?

  coApplicantName     String?
  coApplicantRelation CoApplicantRelation?
  coApplicantContact  String?
  coApplicantIncome   Float?
  coApplicantPan      String?
  coApplicantAadhaar  String?
  totalPayable        Float?
  loanPurpose         String?
  cibilScore          Int?
  status              LoanStatus           @default(application_in_progress)
  approvalDate        DateTime?
  activationDate      DateTime?
  rejectionReason     String?
  approvedBy          String?
  approvedAt          DateTime?
  rejectedBy          String?
  rejectedAt          DateTime?
  kycId               String?              @unique
  kyc                 Kyc?                 @relation(fields: [kycId], references: [id])

  //Emi charges

  //Disbursement Rules
  latePaymentFeeType CommissionType?
  latePaymentFee     Float? // amount or %
  bounceCharges      Float? // amount or %
  emiStartDate       DateTime?
  emiPaymentAmount   Float?

  foreclosureDate        DateTime?
  foreclosureChargesType CommissionType?
  foreclosureAllowed     Boolean         @default(true)
  foreclosureCharges     Float? // amount or %

  prepaymentChargeType CommissionType?
  prepaymentAllowed    Boolean         @default(true)
  prepaymentDate       DateTime?
  prepaymentCharges    Float? // amount or %
  defaultedAt          DateTime?
  dpd                  Int?

  // Relations
  documents      Document[]
  loanRecoveries LoanRecovery[]
  // product         LoanProduct         @relation(fields: [loanProductId], references: [id])
  // approvals       LoanApproval[]
  // disbursements   LoanDisbursement[]
  emis           LoanEmiSchedule[]
  // payments        LoanPayment[]
  // charges         LoanCharge[]
  // statusHistory   LoanStatusHistory[]
  // nachMandates    LoanNachMandate[]
  createdById    String?
  createdBy      User?             @relation(fields: [createdById], references: [id])
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  loanType LoanType? @relation(fields: [loanTypeId], references: [id])

  @@index([loanNumber])
}

model LoanRecovery {
  id String @id @default(cuid())

  loanApplicationId String
  loanApplication   LoanApplication @relation(fields: [loanApplicationId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  recoveryStage  recovery_stage
  recoveryStatus recovery_status

  totalOutstandingAmount Float
  recoveredAmount        Float
  balanceAmount          Float

  // Settlement fields 
  settlementAmount     Float?
  settlementDate       DateTime?
  settlementApprovedBy String?

  dpd         Int
  defaultedAt DateTime?

  assignedTo String?
  remarks    String?

  recoveryPayments RecoveryPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loanApplicationId])
}

model RecoveryPayment {
  id String @id @default(cuid())

  loanRecoveryId String
  loanRecovery   LoanRecovery @relation(fields: [loanRecoveryId], references: [id])

  amount      Float
  paymentDate DateTime
  paymentMode PaymentMode
  referenceNo String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loanRecoveryId])
}

model Permission {
  id              String           @id @default(cuid())
  code            String           @unique
  name            String
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  userPermissions UserPermission[]
}

model UserPermission {
  id           String  @id @default(cuid())
  userId       String
  permissionId String
  allowed      Boolean @default(true)

  user       User       @relation(fields: [userId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([userId, permissionId])
}

model Document {
  id                 String             @id @default(cuid())
  loanApplicationId  String?
  documentType       String
  documentPath       String
  verificationStatus VerificationStatus @default(pending)
  rejectionReason    String?
  kycId              String?
  uploadedBy         String
  verified           Boolean            @default(false)
  verifiedBy         String?
  verifiedAt         DateTime?
  createdAt          DateTime           @default(now())

  kyc             Kyc?             @relation("KycDocuments", fields: [kycId], references: [id])
  loanApplication LoanApplication? @relation(fields: [loanApplicationId], references: [id])

  @@unique([loanApplicationId, documentType]) // âœ… prevents duplicate uploads
}

model Kyc {
  id              String           @id @default(cuid())
  loanApplication LoanApplication?
  documents       Document[]       @relation("KycDocuments")
  userId          String
  status          KycStatus        @default(PENDING)
  remarks         String?

  verifiedBy String?
  verifiedAt DateTime?

  verifiedByUser User? @relation("KycVerifiedBy", fields: [verifiedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

enum KycStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

// Loan products offered by the system
// model LoanProduct {
//   id           String        @id @default(cuid())
//   name         String
//   code         String?       @unique
//   description  String?
//   interestRate Float?
//   category     LoanCategory?
//   createdAt    DateTime      @default(now())
//   updatedAt    DateTime      @updatedAt

//   applications LoanApplication[]
// }

// APPROVAL

// model LoanApproval {
//   id                String        @id @default(cuid())
//   loanApplicationId String
//   approvalLevel     ApprovalLevel
//   approvedAmount    Float
//   approvedInterest  Float
//   remarks           String?

//   loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id])

//   approvedAt DateTime @default(now())
// }

// DISBURSEMENT

// model LoanDisbursement {
//   id                String @id @default(cuid())
//   loanApplicationId String

//   disbursedAmount Decimal @db.Decimal(15, 2)
//   bankAccount     String
//   ifscCode        String
//   transactionRef  String

//   loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id])

//   disbursedAt DateTime @default(now())
// }

// EMI SCHEDULE
//////////////////////////////////

model LoanEmiSchedule {
  id                String @id @default(cuid())
  loanApplicationId String

  emiNo        Int
  emiStartDate DateTime? // EMI cycle start date
  dueDate      DateTime // EMI due date

  openingBalance     Float
  principalAmount    Float
  interestAmount     Float
  emiAmount          Float // Scheduled EMI amount
  emiPaymentAmount   Float? // Actual amount paid (can be partial / excess)
  closingBalance     Float
  totalPayableAmount Float // principal + interest + late fees + bounce charges etc. 

  // Late & penalty
  latePaymentFeeType  LateFeeType @default(FIXED)
  latePaymentFee      Float       @default(0)
  bounceCharges       Float       @default(0) // NACH / cheque bounce charge
  bounceChargeApplied Boolean     @default(false)

  // -------- Payment Audit --------
  lastPaymentMode PaymentMode?
  chequeStatus    ChequeStatus?
  lastPaymentDate DateTime?

  status          EmiStatus       @default(pending)
  paidDate        DateTime?
  isDeferred      Boolean         @default(false)
  loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id])

  @@index([loanApplicationId, emiNo])
  @@index([dueDate, status])
}

model EmiPayment {
  id            String      @id @default(cuid())
  emiScheduleId String
  amount        Float
  paymentDate   DateTime
  paymentMode   PaymentMode
}

model EmiMoratorium {
  id                String           @id @default(cuid())
  loanApplicationId String
  type              MoratoriumType
  startDate         DateTime
  endDate           DateTime
  interestAccrued   Float            @default(0)
  status            MoratoriumStatus @default(active)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

// PAYMENTS
//////////////////////////////////

// model LoanPayment {
//   id                String           @id @default(cuid())
//   loanApplicationId String
//   emiId             String?
//   emi               LoanEmiSchedule? @relation(fields: [emiId], references: [id])

//   paymentAmount  Decimal     @db.Decimal(15, 2)
//   paymentMode    PaymentMode
//   transactionRef String
//   paymentDate    DateTime

//   loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id])
// }

// NACH
//////////////////////////////////

// model LoanNachMandate {
//   id                String @id @default(cuid())
//   loanApplicationId String @unique

//   mandateReference String
//   bankName         String
//   accountNumber    String
//   ifscCode         String
//   status           VerificationStatus

//   loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id])

//   registeredAt DateTime @default(now())
// }

// CHARGES
//////////////////////////////////

// model LoanCharge {
//   id                String     @id @default(cuid())
//   loanApplicationId String
//   chargeType        ChargeType
//   chargeAmount      Decimal    @db.Decimal(15, 2)
//   chargeDate        DateTime
//   status            String

//   loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id])
// }

// STATUS HISTORY

// model LoanStatusHistory {
//   id                String     @id @default(cuid())
//   loanApplicationId String
//   oldStatus         LoanStatus
//   newStatus         LoanStatus
//   remarks           String?

//   loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id])

//   changedAt DateTime @default(now())
// }
model LoanType {
  id String @id @default(cuid())

  //Basic Identification 
  code        String  @unique // Personal Loan, Home Loan ,Vehicle Loan etc.
  name        String
  description String?

  //Classification 

  category LoanTypes
  secured  Boolean   @default(false)

  //Loan Limits 
  minAmount       Float
  maxAmount       Float
  minTenureMonths Int
  maxTenureMonths Int

  //Interest configuration

  interestType        InterestType
  minInterestRate     Float
  maxInterestRate     Float
  defaultInterestRate Float

  //processing & Charges
  processingFeeType CommissionType
  processingFee     Float // amount or %
  gstApplicable     Boolean        @default(true)
  gstPercentage     Float? //usually 18%

  //Eligibility Criteria 
  minAge         Int
  maxAge         Int
  minIncome      Float?
  employmentType EmploymentType?

  //Risk & Credit 

  minCibilScore Int?
  maxCibilScore Int?

  //Disbursement Rules
  maxLoanToValueRatio Float? //for secured loans
  prepaymentAllowed   Boolean @default(true)
  foreclosureAllowed  Boolean @default(true)

  prepaymentCharges  Float? // amount or %
  foreclosureCharges Float? // amount or %

  //Emi charges
  latePaymentFeeType CommissionType?
  latePaymentFee     Float? // amount or %
  bounceCharges      Float? // amount or %

  //visibility & Control 

  isActive         Boolean @default(true)
  isPublic         Boolean @default(true)
  approvalRequired Boolean @default(true)

  //SLA & WorkFlow 
  estimatedProcessingTimeDays Int? //turnaround time
  documentsRequired           String? //list of documents /comma separated 

  //Audit Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  leads            Leads[]
  loanApplications LoanApplication[]
}

//===================================CUSTOMER=====================================

model Customer {
  id              String         @id @default(cuid())
  title           Title
  firstName       String
  lastName        String
  middleName      String?
  gender          Gender
  dob             DateTime
  aadhaarNumber   String?
  panNumber       String?
  voterId         String?
  maritalStatus   MaritalStatus?
  nationality     String?
  category        Category?
  spouseName      String?
  passportNumber  String?
  contactNumber   String
  alternateNumber String?
  email           String?

  address String
  city    String
  state   String
  pinCode String

  employmentType EmploymentType

  monthlyIncome     Float?
  annualIncome      Float?
  bankName          String?
  bankAccountNumber String?
  otherIncome       Float?
  ifscCode          String?
  accountType       String?

  status           CustomerStatus    @default(ACTIVE)
  loanApplications LoanApplication[]
  loanRecoveries   LoanRecovery[]
  // kycs             CustomerKYC[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

// ================================CUSTOMER KYC=====================================

// model CustomerKYC {
//   id               String    @id @default(cuid())
//   customerId       String
//   documentType     KycType
//   documentNumber   String
//   documentFilePath String
//   issuedBy         String?
//   issueDate        DateTime?
//   expiryDate       DateTime?
//   createdAt        DateTime  @default(now())
//   updatedAt        DateTime  @updatedAt

//   customer Customer @relation(fields: [customerId], references: [id])
// }

// =================================ENUMS=====================================

enum Role {
  ADMIN
  EMPLOYEE
  PARTNER
}

enum MoratoriumStatus {
  active
  completed
}

enum recovery_stage {
  INITIAL_CONTACT
  FIELD_VISIT
  NEGOTIATION
  LEGAL_ACTION
  SETTLEMENT_REQUESTED
  SETTLEMENT_APPROVED
  SETTLEMENT
  CLOSED
}

enum recovery_status {
  ONGOING
  IN_PROGRESS
  RESOLVED
  WRITE_OFF
  SETTLED
  COMPLETED
}

enum MoratoriumType {
  FULL
  INTEREST_ONLY
}

enum Category {
  GENERAL
  SC
  ST
  OBC
  OTHER
}

enum CoApplicantRelation {
  SPOUSE
  PARTNER
  BUSINESS_PARTNER

  FATHER
  MOTHER
  SIBLING
  FRIEND
  OTHER
}

enum LateFeeType {
  FIXED
  PERCENTAGE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  OTHER
}

enum PaymentMode {
  CASH
  UPI
  BANK
  CHEQUE
}

enum ChequeStatus {
  PENDING
  CLEARED
  BOUNCED
}

enum Relationship {
  FATHER
  MOTHER
  SPOUSE
  SIBLING
  FRIEND
  OTHER
}

enum WorkLocation {
  OFFICE
  REMOTE
  HYBRID
}

enum LoanTypes {
  PERSONAL_LOAN
  VEHICLE_LOAN
  HOME_LOAN
  EDUCATION_LOAN
  BUSINESS_LOAN
  GOLD_LOAN
}

enum LeadStatus {
  CONTACTED
  INTERESTED
  APPLICATION_IN_PROGRESS
  APPLICATION_SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  FUNDED
  CLOSED
  DROPPED
  PENDING
}

enum PartnerType {
  INDIVIDUAL
  COMPANY
  INSTITUTION
  CORPORATE
  AGENCY
}

enum CommissionType {
  FIXED
  PERCENTAGE
}

enum PaymentCycle {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  PER_TRANSACTION
}

enum Title {
  MR
  MRS
  MS
  DR
  PROF
}

enum EmploymentType {
  salaried
  self_employed
  business
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLACKLISTED
}

enum KycType {
  aadhaar
  pan
  video
  ckyc
}

enum VerificationStatus {
  pending
  verified
  rejected
}

enum LoanCategory {
  personal
  home
  vehicle
  education
  gold
  business
}

enum InterestType {
  FLAT
  REDUCING
}

enum LoanStatus {
  draft
  submitted
  kyc_pending
  credit_check
  under_review
  approved
  rejected
  disbursed
  active
  closed
  delinquent
  written_off
  defaulted
  application_in_progress
}

enum ApprovalLevel {
  l1
  l2
  l3
}

enum EmiStatus {
  pending
  paid
  overdue
}

enum ChargeType {
  late_fee
  penalty
  bounce
  foreclosure
}
